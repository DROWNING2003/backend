# å…³å¡APIä¿®æ”¹è¯´æ˜

## ğŸ¯ ä¿®æ”¹ç›®æ ‡

å°†å…³å¡APIçš„ `/levels/get` ç«¯ç‚¹ä¿®æ”¹ä¸ºï¼š
- æ¥æ”¶è¯¾ç¨‹IDå’Œå…³å¡IDä½œä¸ºå‚æ•°
- è·å–å¯¹åº”Gitæäº¤çš„æ–‡ä»¶å†…å®¹
- è¿”å›æ ‘å½¢ç»“æ„çš„æ–‡ä»¶æ•°æ®

## ğŸ“‹ ä¿®æ”¹å†…å®¹

### 1. Schemaä¿®æ”¹ (`app/schemas/level.py`)

#### æ–°å¢æ–‡ä»¶æ ‘èŠ‚ç‚¹ç»“æ„
```python
class FileTreeNode(BaseModel):
    """æ–‡ä»¶æ ‘èŠ‚ç‚¹"""
    type: str = Field(..., description="èŠ‚ç‚¹ç±»å‹: file æˆ– directory")
    uri: str = Field(..., description="æ–‡ä»¶URI")
    children: Optional[List['FileTreeNode']] = Field(None, description="å­èŠ‚ç‚¹ï¼ˆä»…ç›®å½•æœ‰ï¼‰")
    content: Optional[str] = Field(None, description="æ–‡ä»¶å†…å®¹ï¼ˆä»…æ–‡ä»¶æœ‰ï¼‰")
```

#### ä¿®æ”¹è¯·æ±‚æ¨¡å¼
```python
class LevelGetRequest(BaseModel):
    """è·å–å…³å¡è¯¦æƒ…çš„è¯·æ±‚æ¨¡å¼"""
    course_id: int = Field(..., description="è¯¾ç¨‹ID")
    level_id: int = Field(..., description="å…³å¡ID")
```

#### ä¿®æ”¹å“åº”æ¨¡å¼
```python
class LevelResponse(BaseModel):
    # ... åŸæœ‰å­—æ®µ ...
    file_tree: Optional[FileTreeNode] = Field(None, description="é¡¹ç›®æ–‡ä»¶æ ‘ç»“æ„")
```

### 2. æ–‡ä»¶æ ‘æ„å»ºå·¥å…· (`app/utils/file_tree_builder.py`)

æ–°å¢å·¥å…·å‡½æ•°ï¼š
- `build_file_tree_from_files()` - ä»æ–‡ä»¶å­—å…¸æ„å»ºæ ‘ç»“æ„
- `sort_file_tree()` - å¯¹æ–‡ä»¶æ ‘æ’åº
- `filter_file_tree_by_patterns()` - æŒ‰æ¨¡å¼è¿‡æ»¤æ–‡ä»¶æ ‘
- `get_file_tree_stats()` - è·å–æ–‡ä»¶æ ‘ç»Ÿè®¡ä¿¡æ¯

### 3. APIè·¯ç”±ä¿®æ”¹ (`app/routers/levels.py`)

#### æ ¸å¿ƒé€»è¾‘æµç¨‹
1. **éªŒè¯å‚æ•°** - æ£€æŸ¥è¯¾ç¨‹IDå’Œå…³å¡IDçš„æœ‰æ•ˆæ€§
2. **è·å–è¯¾ç¨‹ä¿¡æ¯** - ä»æ•°æ®åº“è·å–Gitä»“åº“URL
3. **å…‹éš†ä»“åº“** - ä¸´æ—¶å…‹éš†Gitä»“åº“
4. **é‡ç½®åˆ°æŒ‡å®šæäº¤** - æ ¹æ®å…³å¡é¡ºåºå·è®¡ç®—æäº¤ç´¢å¼•
5. **è·å–æ–‡ä»¶** - ä½¿ç”¨æ–‡ä»¶æ¨¡å¼è¿‡æ»¤è·å–ä»£ç æ–‡ä»¶
6. **æ„å»ºæ–‡ä»¶æ ‘** - å°†æ–‡ä»¶è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„
7. **è¿”å›å“åº”** - åŒ…å«å…³å¡ä¿¡æ¯å’Œæ–‡ä»¶æ ‘

#### å…³é”®ä»£ç ç‰‡æ®µ
```python
# è®¡ç®—æäº¤ç´¢å¼•ï¼ˆå…³å¡é¡ºåºå· + 1ï¼Œå› ä¸ºä»ç¬¬2ä¸ªæäº¤å¼€å§‹ï¼‰
current_index = level_result.order_number + 1

# é‡ç½®åˆ°æŒ‡å®šæäº¤
commits = list(repo.iter_commits(reverse=True))
reset_to_commit(repo, commits, current_index)

# è·å–æ–‡ä»¶
result = filter_and_read_files(
    tmpdirname,
    max_file_size=1 * 1024 * 1024,
    include_patterns=get_file_patterns("code"),
    exclude_patterns=get_exclude_patterns("common")
)

# æ„å»ºæ–‡ä»¶æ ‘
project_name = course.git_url.split('/')[-1].replace('.git', '')
base_uri = f"file:///github/{project_name}"
file_tree = build_file_tree_from_files(result["files"], base_uri)
```

## ğŸ”§ APIä½¿ç”¨æ–¹å¼

### è¯·æ±‚æ ¼å¼
```http
POST /levels/get
Content-Type: application/json

{
    "course_id": 1,
    "level_id": 3
}
```

### å“åº”æ ¼å¼
```json
{
    "id": 3,
    "course_id": 1,
    "title": "å‡½æ•°å®šä¹‰ä¸è°ƒç”¨",
    "description": "å­¦ä¹ å¦‚ä½•åœ¨Pythonä¸­å®šä¹‰å’Œè°ƒç”¨å‡½æ•°",
    "requirements": "åˆ›å»ºä¸€ä¸ªç®€å•çš„å‡½æ•°å¹¶è°ƒç”¨å®ƒ",
    "order_number": 3,
    "file_tree": {
        "type": "directory",
        "uri": "file:///github/auto_mate_test2",
        "children": [
            {
                "type": "file",
                "uri": "file:///github/auto_mate_test2/hello_world.py",
                "content": "print('Hello, World!')"
            }
        ]
    }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶
- `test_level_api.py` - æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
- `level_api_example.py` - APIä½¿ç”¨ç¤ºä¾‹

### æµ‹è¯•ç»“æœ
âœ… æˆåŠŸå…‹éš†Gitä»“åº“  
âœ… æ­£ç¡®é‡ç½®åˆ°æŒ‡å®šæäº¤  
âœ… è·å–å¹¶è¿‡æ»¤ä»£ç æ–‡ä»¶  
âœ… æ„å»ºæ ‘å½¢æ–‡ä»¶ç»“æ„  
âœ… è¿”å›æ­£ç¡®çš„JSONæ ¼å¼  

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹
```
é‡ç½®åˆ°ç¬¬ 3 ä¸ªæäº¤: a8a51103 - hello_worldåŸºç¡€å…¥é—¨
è·å–åˆ° 1 ä¸ªæ–‡ä»¶
âœ… æˆåŠŸç”Ÿæˆæ–‡ä»¶æ ‘ï¼Œæ ¹èŠ‚ç‚¹ç±»å‹: directory
   æ ¹URI: file:///github/auto_mate_test2
   å­èŠ‚ç‚¹æ•°é‡: 1
```

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½
- [x] æ¥æ”¶è¯¾ç¨‹IDå’Œå…³å¡IDå‚æ•°
- [x] éªŒè¯å…³å¡å±äºæŒ‡å®šè¯¾ç¨‹
- [x] æ ¹æ®å…³å¡é¡ºåºå·è®¡ç®—Gitæäº¤ç´¢å¼•
- [x] å…‹éš†Gitä»“åº“å¹¶é‡ç½®åˆ°æŒ‡å®šæäº¤
- [x] è¿‡æ»¤è·å–ä»£ç æ–‡ä»¶ï¼ˆæ’é™¤.gitã€node_modulesç­‰ï¼‰
- [x] æ„å»ºæ ‘å½¢æ–‡ä»¶ç»“æ„
- [x] åŒ…å«æ–‡ä»¶å†…å®¹åœ¨å“åº”ä¸­
- [x] é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†
- [x] å®Œæ•´çš„æµ‹è¯•éªŒè¯

### ğŸ”„ æäº¤ç´¢å¼•æ˜ å°„
- å…³å¡1 â†’ Gitæäº¤2ï¼ˆç¬¬2ä¸ªæäº¤ï¼‰
- å…³å¡2 â†’ Gitæäº¤3ï¼ˆç¬¬3ä¸ªæäº¤ï¼‰
- å…³å¡N â†’ Gitæäº¤N+1

### ğŸ“ æ–‡ä»¶è¿‡æ»¤è§„åˆ™
**åŒ…å«æ¨¡å¼ï¼ˆä»£ç æ–‡ä»¶ï¼‰ï¼š**
- `*.py`, `*.js`, `*.ts`, `*.java`, `*.cpp`, `*.c`, `*.h`
- `*.cs`, `*.go`, `*.rs`, `*.php`

**æ’é™¤æ¨¡å¼ï¼ˆå¸¸è§æ— ç”¨æ–‡ä»¶ï¼‰ï¼š**
- `*/node_modules/*`, `*/.git/*`, `*/venv/*`
- `*/__pycache__/*`, `*.pyc`, `*/dist/*`, `*/build/*`

## ğŸš€ éƒ¨ç½²è¯´æ˜

### ä¾èµ–è¦æ±‚
- FastAPI
- SQLAlchemy
- GitPython
- Pydantic v2

### ç¯å¢ƒé…ç½®
ç¡®ä¿æœåŠ¡å™¨æœ‰Gitè®¿é—®æƒé™ï¼Œèƒ½å¤Ÿå…‹éš†æŒ‡å®šçš„Gitä»“åº“ã€‚

### æ€§èƒ½è€ƒè™‘
- ä½¿ç”¨ä¸´æ—¶ç›®å½•é¿å…ç£ç›˜å ç”¨
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤1MBï¼‰
- åªè·å–ä»£ç æ–‡ä»¶ï¼Œæ’é™¤äºŒè¿›åˆ¶æ–‡ä»¶

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†å…³å¡APIçš„å¢å¼ºåŠŸèƒ½ï¼š
1. **å‚æ•°å‡çº§** - ä»å•ä¸€å…³å¡IDåˆ°è¯¾ç¨‹ID+å…³å¡ID
2. **Gité›†æˆ** - åŠ¨æ€è·å–å¯¹åº”æäº¤çš„æ–‡ä»¶å†…å®¹
3. **æ ‘å½¢ç»“æ„** - ä»¥æ ‡å‡†æ–‡ä»¶æ ‘æ ¼å¼è¿”å›é¡¹ç›®ç»“æ„
4. **å†…å®¹åŒ…å«** - ç›´æ¥åœ¨å“åº”ä¸­åŒ…å«æ–‡ä»¶å†…å®¹
5. **å®Œæ•´æµ‹è¯•** - æä¾›æµ‹è¯•å·¥å…·å’Œä½¿ç”¨ç¤ºä¾‹

è¿™ä¸ªAPIç°åœ¨å¯ä»¥ä¸ºå‰ç«¯æä¾›å®Œæ•´çš„é¡¹ç›®æ–‡ä»¶ç»“æ„ï¼Œæ”¯æŒä»£ç ç¼–è¾‘å™¨ã€æ–‡ä»¶æµè§ˆå™¨ç­‰åŠŸèƒ½çš„å®ç°ã€‚